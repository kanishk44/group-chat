<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <title>Chat</title>
    <style>
      #messages {
        height: 400px;
        overflow-y: scroll;
        border: 1px solid #ccc;
        margin-bottom: 20px;
        padding: 10px;
      }
      .message {
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 10px;
        max-width: 70%;
      }
      .message.sender {
        background-color: #d1e7dd; /* Light green for sender */
        margin-left: auto; /* Align to the right */
      }
      .message.receiver {
        background-color: #f8d7da; /* Light red for receiver */
      }
      .message:last-child {
        border-bottom: none;
      }
      .user,
      .group {
        cursor: pointer;
        padding: 10px;
        margin-bottom: 5px;
      }
      .user:hover,
      .group:hover {
        background-color: #f8f9fa;
      }
      .active {
        background-color: #e9ecef;
      }
      .chat-type {
        font-weight: bold;
        margin-bottom: 10px;
      }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  </head>
  <body>
    <div class="container mt-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-center mb-0">Chat App</h2>
        <div>
          <span class="mr-3" id="currentUser"></span>
          <button id="logoutButton" class="btn btn-danger">Logout</button>
        </div>
      </div>
      <div class="row">
        <div class="col-md-4">
          <!-- Groups Section -->
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center">
              <h5>Groups</h5>
              <button
                class="btn btn-sm btn-primary"
                data-toggle="modal"
                data-target="#createGroupModal"
              >
                New Group
              </button>
            </div>
            <div id="groupList" class="list-group"></div>
          </div>

          <!-- Users Section -->
          <div>
            <h5>Online Users</h5>
            <div id="userList" class="list-group"></div>
          </div>
        </div>

        <div class="col-md-8">
          <div id="chatHeader" class="mb-3">
            <h5 id="currentChat">Select a chat to start messaging</h5>
          </div>
          <div id="messages" class="mb-3"></div>
          <div class="input-group">
            <input
              type="text"
              id="messageInput"
              placeholder="Type a message..."
              class="form-control"
            />
            <div class="input-group-append">
              <button id="sendButton" class="btn btn-primary">Send</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Group Modal -->
    <div class="modal fade" id="createGroupModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Create New Group</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label>Group Name</label>
              <input type="text" class="form-control" id="groupName" required />
            </div>
            <div class="form-group">
              <label>Select Members</label>
              <div
                id="memberSelection"
                class="border p-2"
                style="max-height: 200px; overflow-y: auto"
              >
                <!-- User checkboxes will be added here -->
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="createGroupButton"
            >
              Create Group
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Group Management Modal -->
    <div class="modal fade" id="groupManageModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Manage Group</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <!-- Group Info -->
            <div class="group-info mb-4">
              <h6>Group Name: <span id="groupManageName"></span></h6>
            </div>

            <!-- Member Management -->
            <div class="member-management">
              <div class="mb-3">
                <h6 class="mb-0">Members</h6>
              </div>

              <!-- Member Search -->
              <div class="form-group">
                <input
                  type="text"
                  class="form-control"
                  id="memberSearch"
                  placeholder="Search members..."
                />
              </div>

              <!-- Members List -->
              <div id="membersList" class="list-group mb-3">
                <!-- Members will be added here dynamically -->
              </div>

              <!-- Add Members Button -->
              <div class="text-center">
                <button
                  class="btn btn-primary"
                  id="addMembersBtn"
                  style="display: none"
                >
                  Add Members
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Members Modal -->
    <div class="modal fade" id="addMembersModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Members</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <input
                type="text"
                class="form-control"
                id="userSearch"
                placeholder="Search users..."
              />
            </div>
            <div id="userSearchResults" class="list-group">
              <!-- Search results will be added here -->
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="confirmAddMembers"
            >
              Add Selected
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentChatType = null; // 'direct' or 'group'
      let currentChatId = null;
      let lastMessageId = null;
      let isGroupAdmin = false;
      let selectedUsers = new Set();
      let currentGroupMembers = new Set();

      // Function to get conversation key
      function getConversationKey(userId1, userId2) {
        // Sort IDs to ensure consistent key regardless of sender/receiver
        const sortedIds = [userId1, userId2].sort();
        return `messages_${sortedIds[0]}_${sortedIds[1]}`;
      }

      // Function to fetch with authorization
      async function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem("token");
        options.headers = {
          ...options.headers,
          Authorization: `Bearer ${token}`,
        };
        return fetch(url, options);
      }

      // Fetch groups
      async function fetchGroups() {
        const response = await fetchWithAuth("http://localhost:3000/groups");
        const groups = await response.json();
        const groupList = document.getElementById("groupList");
        groupList.innerHTML = groups
          .map(
            (group) =>
              `<div class="group list-group-item" data-id="${group.id}" data-type="group">
                ${group.name}
               </div>`
          )
          .join("");

        // Add click event to each group
        document.querySelectorAll(".group").forEach((group) => {
          group.addEventListener("click", async () => {
            currentChatType = "group";
            currentChatId = group.getAttribute("data-id");

            // Add manage button if not already present
            const chatHeader = document.getElementById("currentChat");
            chatHeader.innerHTML = `
              <div class="d-flex justify-content-between align-items-center">
                <span>Group: ${group.innerText}</span>
                <button class="btn btn-sm btn-info" onclick="openGroupManagement()">
                  Manage
                </button>
              </div>
            `;

            await checkAdminStatus();
            fetchGroupMessages(currentChatId);
          });
        });
      }

      // Fetch online users
      async function fetchOnlineUsers() {
        const response = await fetchWithAuth(
          "http://localhost:3000/online-users"
        );
        const users = await response.json();
        const userList = document.getElementById("userList");
        userList.innerHTML = users
          .map(
            (user) =>
              `<div class="user list-group-item" data-id="${user.id}" data-type="direct">
                ${user.name}
               </div>`
          )
          .join("");

        // Add click event to each user
        document.querySelectorAll(".user").forEach((user) => {
          user.addEventListener("click", () => {
            currentChatType = "direct";
            currentChatId = user.getAttribute("data-id");
            document.getElementById(
              "currentChat"
            ).innerText = `Chat with: ${user.innerText}`;

            // Clear lastMessageId when switching conversations
            lastMessageId = null;

            // Load existing messages for this conversation
            const conversationKey = getConversationKey(
              localStorage.getItem("userId"),
              currentChatId
            );
            const existingMessages =
              JSON.parse(localStorage.getItem(conversationKey)) || [];
            displayMessages(existingMessages);

            // Then fetch any new messages
            fetchMessages();
          });
        });

        // Update member selection in create group modal
        const memberSelection = document.getElementById("memberSelection");
        memberSelection.innerHTML = users
          .map(
            (user) =>
              `<div class="form-check">
                <input class="form-check-input" type="checkbox" value="${user.id}" id="user${user.id}">
                <label class="form-check-label" for="user${user.id}">
                  ${user.name}
                </label>
              </div>`
          )
          .join("");
      }

      // Create group
      document
        .getElementById("createGroupButton")
        .addEventListener("click", async () => {
          const name = document.getElementById("groupName").value;
          const selectedMembers = Array.from(
            document.querySelectorAll("#memberSelection input:checked")
          ).map((checkbox) => checkbox.value);

          if (selectedMembers.length < 1) {
            alert("Please select at least one member");
            return;
          }

          try {
            const response = await fetchWithAuth(
              "http://localhost:3000/groups",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ name, members: selectedMembers }),
              }
            );

            if (response.ok) {
              $("#createGroupModal").modal("hide");
              document.getElementById("groupName").value = "";
              fetchGroups();
            } else {
              const data = await response.json();
              alert(data.error || "Failed to create group");
            }
          } catch (error) {
            console.error("Error creating group:", error);
            alert("Failed to create group");
          }
        });

      // Send message
      document
        .getElementById("sendButton")
        .addEventListener("click", async () => {
          if (!currentChatType || !currentChatId) {
            alert("Please select a chat first");
            return;
          }

          const messageInput = document.getElementById("messageInput");
          const content = messageInput.value.trim();

          if (!content) {
            return; // Don't send empty messages
          }

          try {
            if (currentChatType === "direct") {
              const response = await fetchWithAuth(
                "http://localhost:3000/messages",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({ receiverId: currentChatId, content }),
                }
              );

              if (response.ok) {
                const newMessage = await response.json();
                const conversationKey = getConversationKey(
                  localStorage.getItem("userId"),
                  currentChatId
                );
                const existingMessages =
                  JSON.parse(localStorage.getItem(conversationKey)) || [];
                existingMessages.push(newMessage);
                localStorage.setItem(
                  conversationKey,
                  JSON.stringify(existingMessages.slice(-10))
                );
                displayMessages(existingMessages);
              }
            } else {
              const response = await fetchWithAuth(
                `http://localhost:3000/groups/${currentChatId}/messages`,
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({ content }),
                }
              );

              if (!response.ok) {
                throw new Error("Failed to send group message");
              }

              // Fetch latest messages immediately
              await fetchGroupMessages(currentChatId);
            }

            messageInput.value = ""; // Clear input only if message was sent successfully
          } catch (error) {
            console.error("Error sending message:", error);
            alert("Failed to send message");
          }
        });

      // Fetch messages
      async function fetchMessages() {
        const receiverId = currentChatId;
        if (!receiverId) return;

        try {
          const response = await fetchWithAuth(
            `http://localhost:3000/messages?receiverId=${receiverId}${
              lastMessageId ? `&lastMessageId=${lastMessageId}` : ""
            }`
          );
          const newMessages = await response.json();

          if (newMessages.length > 0) {
            // Update lastMessageId to the newest message's ID
            lastMessageId = Math.max(...newMessages.map((msg) => msg.id));

            const currentUserId = localStorage.getItem("userId");
            const conversationKey = getConversationKey(
              currentUserId,
              receiverId
            );

            // Get existing messages for this conversation
            const existingMessages =
              JSON.parse(localStorage.getItem(conversationKey)) || [];

            // Combine messages, removing duplicates
            const allMessages = [...existingMessages, ...newMessages].reduce(
              (acc, current) => {
                const x = acc.find((item) => item.id === current.id);
                if (!x) {
                  return acc.concat([current]);
                } else {
                  return acc;
                }
              },
              []
            );

            // Keep only the last 10 messages
            const recentMessages = allMessages.slice(-10);

            // Store messages for this specific conversation
            localStorage.setItem(
              conversationKey,
              JSON.stringify(recentMessages)
            );

            // Display messages
            displayMessages(recentMessages);
          }
        } catch (error) {
          console.error("Error fetching messages:", error);
        }
      }

      // Fetch group messages
      async function fetchGroupMessages(groupId) {
        try {
          const response = await fetchWithAuth(
            `http://localhost:3000/groups/${groupId}/messages`
          );
          const messages = await response.json();
          displayMessages(messages);
        } catch (error) {
          console.error("Error fetching group messages:", error);
        }
      }

      // Display messages
      function displayMessages(messages) {
        const messagesDiv = document.getElementById("messages");
        const currentUserId = localStorage.getItem("userId");

        messagesDiv.innerHTML = messages
          .map((msg) => {
            const senderName = msg.sender ? msg.sender.name : "Unknown";
            const isSender = msg.senderId === parseInt(currentUserId);
            return `
              <div class="message ${isSender ? "sender" : "receiver"}">
                <strong>${senderName}:</strong> ${msg.content}
              </div>`;
          })
          .join("");
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      // Logout functionality
      document.getElementById("logoutButton").addEventListener("click", () => {
        localStorage.removeItem("token");
        localStorage.removeItem("userId");
        localStorage.removeItem("userName");
        window.location.href = "/login";
      });

      // Check admin status
      async function checkAdminStatus() {
        try {
          const response = await fetchWithAuth(
            `http://localhost:3000/groups/${currentChatId}/members`
          );
          if (!response.ok) {
            throw new Error("Failed to fetch members");
          }
          const members = await response.json();

          const currentUserId = parseInt(localStorage.getItem("userId"));
          const userMembership = members.find(
            (member) => member.User.id === currentUserId
          );

          isGroupAdmin = userMembership?.isAdmin || false;

          // Update UI based on admin status
          updateAdminUI();
        } catch (error) {
          console.error("Error checking admin status:", error);
        }
      }

      // Update UI based on admin status
      function updateAdminUI() {
        const addMembersBtn = document.getElementById("addMembersBtn");
        if (addMembersBtn) {
          addMembersBtn.style.display = isGroupAdmin ? "block" : "none";
        }
      }

      // Open group management modal
      async function openGroupManagement() {
        const groupName = document
          .getElementById("currentChat")
          .querySelector("span")
          .innerText.replace("Group: ", "");
        document.getElementById("groupManageName").textContent = groupName;

        await fetchGroupMembers();

        document.getElementById("addMembersBtn").style.display = isGroupAdmin
          ? "block"
          : "none";

        $("#groupManageModal").modal("show");
      }

      // Fetch group members
      async function fetchGroupMembers() {
        try {
          const response = await fetchWithAuth(
            `http://localhost:3000/groups/${currentChatId}/members`
          );
          const members = await response.json();

          // Update current group members set
          currentGroupMembers = new Set(
            members.map((member) => member.User.id)
          );

          displayGroupMembers(members);
        } catch (error) {
          console.error("Error fetching members:", error);
        }
      }

      // Display group members
      function displayGroupMembers(members) {
        const membersList = document.getElementById("membersList");
        const currentUserId = parseInt(localStorage.getItem("userId"));

        membersList.innerHTML = members
          .map(
            (member) => `
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  ${member.User.name}
                  ${
                    member.isAdmin
                      ? '<span class="badge badge-primary ml-2">Admin</span>'
                      : ""
                  }
                </div>
                ${
                  isGroupAdmin && member.User.id !== currentUserId
                    ? `
                      <div class="btn-group">
                        <button class="btn btn-sm btn-${
                          member.isAdmin ? "warning" : "success"
                        }"
                                onclick="toggleAdmin(${
                                  member.User.id
                                }, ${!member.isAdmin})">
                          ${member.isAdmin ? "Demote" : "Make Admin"}
                        </button>
                        <button class="btn btn-sm btn-danger"
                                onclick="removeMember(${member.User.id})">
                          Remove
                        </button>
                      </div>
                    `
                    : ""
                }
              </div>
            `
          )
          .join("");
      }

      // Toggle admin status
      async function toggleAdmin(userId, makeAdmin) {
        try {
          const response = await fetchWithAuth(
            `http://localhost:3000/groups/${currentChatId}/admins`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                userId,
                action: makeAdmin ? "promote" : "demote",
              }),
            }
          );

          if (response.ok) {
            await fetchGroupMembers(); // Refresh member list
          } else {
            throw new Error("Failed to update admin status");
          }
        } catch (error) {
          console.error("Error updating admin status:", error);
          alert("Failed to update admin status");
        }
      }

      // Remove member
      async function removeMember(userId) {
        if (!confirm("Are you sure you want to remove this member?")) return;

        try {
          const response = await fetchWithAuth(
            `http://localhost:3000/groups/${currentChatId}/members`,
            {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ userIds: [userId] }),
            }
          );

          if (response.ok) {
            await fetchGroupMembers(); // Refresh member list
          } else {
            throw new Error("Failed to remove member");
          }
        } catch (error) {
          console.error("Error removing member:", error);
          alert("Failed to remove member");
        }
      }

      // Add member search functionality
      document
        .getElementById("memberSearch")
        .addEventListener("input", async (e) => {
          const searchTerm = e.target.value;
          try {
            const response = await fetchWithAuth(
              `http://localhost:3000/groups/${currentChatId}/members?searchTerm=${searchTerm}`
            );
            const members = await response.json();
            displayGroupMembers(members);
          } catch (error) {
            console.error("Error searching members:", error);
          }
        });

      // Add Members button click handler
      document.getElementById("addMembersBtn").addEventListener("click", () => {
        $("#addMembersModal").modal("show");
      });

      // Initialize
      window.onload = () => {
        // Display current user
        const userName = localStorage.getItem("userName");
        document.getElementById(
          "currentUser"
        ).innerText = `Logged in as: ${userName}`;

        fetchGroups();
        fetchOnlineUsers();
        setInterval(() => {
          if (currentChatType === "direct") {
            fetchMessages();
          } else if (currentChatType === "group" && currentChatId) {
            fetchGroupMessages(currentChatId);
          }
        }, 1000);
      };

      // Initialize modals when document is ready
      $(document).ready(() => {
        $("#groupManageModal").on("shown.bs.modal", () => {
          document.getElementById("memberSearch").focus();
        });

        $("#addMembersModal").on("shown.bs.modal", () => {
          document.getElementById("userSearch").focus();
        });

        // Add Members button click handler
        document
          .getElementById("addMembersBtn")
          .addEventListener("click", () => {
            $("#addMembersModal").modal("show");
          });
      });

      // Make functions available globally
      window.openGroupManagement = async function () {
        const groupName = document
          .getElementById("currentChat")
          .querySelector("span")
          .innerText.replace("Group: ", "");
        document.getElementById("groupManageName").textContent = groupName;

        await fetchGroupMembers();

        document.getElementById("addMembersBtn").style.display = isGroupAdmin
          ? "block"
          : "none";

        $("#groupManageModal").modal("show");
      };

      window.toggleAdmin = toggleAdmin;
      window.removeMember = removeMember;

      // Add this function to handle user search
      async function searchUsers(searchTerm) {
        try {
          const response = await fetchWithAuth(
            `http://localhost:3000/users/search?searchTerm=${searchTerm}`
          );
          const users = await response.json();

          // Filter out users who are already members
          const filteredUsers = users.filter(
            (user) => !currentGroupMembers.has(user.id)
          );

          displayUserSearchResults(filteredUsers);
        } catch (error) {
          console.error("Error searching users:", error);
        }
      }

      // Add this function to display search results
      function displayUserSearchResults(users) {
        const resultsDiv = document.getElementById("userSearchResults");
        resultsDiv.innerHTML = users
          .map(
            (user) => `
              <div class="list-group-item">
                <div class="form-check">
                  <input
                    type="checkbox"
                    class="form-check-input"
                    id="user-${user.id}"
                    value="${user.id}"
                    ${selectedUsers.has(user.id) ? "checked" : ""}
                    onchange="toggleUserSelection(${user.id})"
                  />
                  <label class="form-check-label" for="user-${user.id}">
                    ${user.name} (${user.email})
                  </label>
                </div>
              </div>
            `
          )
          .join("");
      }

      // Add this function to handle user selection
      window.toggleUserSelection = function (userId) {
        if (selectedUsers.has(userId)) {
          selectedUsers.delete(userId);
        } else {
          selectedUsers.add(userId);
        }
      };

      // Add this function to handle adding selected members
      async function addSelectedMembers() {
        if (selectedUsers.size === 0) {
          alert("Please select users to add");
          return;
        }

        try {
          const response = await fetchWithAuth(
            `http://localhost:3000/groups/${currentChatId}/members`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                userIds: Array.from(selectedUsers),
              }),
            }
          );

          if (response.ok) {
            selectedUsers.clear();
            await fetchGroupMembers();
            $("#addMembersModal").modal("hide");
          } else {
            throw new Error("Failed to add members");
          }
        } catch (error) {
          console.error("Error adding members:", error);
          alert("Failed to add members");
        }
      }

      // Add these event listeners
      document.addEventListener("DOMContentLoaded", function () {
        // User search input handler
        document.getElementById("userSearch").addEventListener("input", (e) => {
          const searchTerm = e.target.value.trim();
          if (searchTerm) {
            searchUsers(searchTerm);
          } else {
            document.getElementById("userSearchResults").innerHTML = "";
          }
        });

        // Add members confirmation button
        document
          .getElementById("confirmAddMembers")
          .addEventListener("click", addSelectedMembers);

        // Clear selections when modal is hidden
        $("#addMembersModal").on("hidden.bs.modal", () => {
          selectedUsers.clear();
          document.getElementById("userSearch").value = "";
          document.getElementById("userSearchResults").innerHTML = "";
        });
      });
    </script>
  </body>
</html>
